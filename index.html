<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SASNO · Mapa-Pop</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet"/>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
<script src="https://js.pusher.com/8.2/pusher.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet"/>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Poppins,Arial,Helvetica,sans-serif;background:#000;color:#fff}
#map{position:fixed;inset:0}

/* ===== Estilo ÚNICO solicitado (cristal) ===== */
:root{
  --glass-bg: rgba(255,255,255,.1);
  --glass-br: rgba(255,255,255,.2);
}
.btn,
.sim,
#hud,
#sema,
#log,
#simMenu,
#overlay .panel,
#configPanel,
#errPanel,
#popupCard{
  background:var(--glass-bg);
  border:1px solid var(--glass-br);
  backdrop-filter:blur(10px);
  padding:24px 28px;
  border-radius:18px;
  text-align:center;
}

/* Barra izquierda */
#leftRail{position:fixed;top:16px;left:16px;z-index:10;display:flex;flex-direction:column;gap:12px;max-width:420px}
#ctrl{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap}
#alertWrap{position:relative;display:flex;gap:10px;align-items:flex-start}

/* Botones */
.btn{
  color:#fff;
  cursor:pointer;
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:center;
  font-weight:700;
  white-space:nowrap;
}
.btn:hover{filter:brightness(1.12)}
.btn[disabled]{opacity:.5;cursor:not-allowed}
#alertBtn svg{width:20px;height:20px}

/* Menú simulacros */
#simMenu{
  position:absolute;top:64px;left:0;min-width:240px;
  display:none;flex-direction:column;gap:10px;z-index:20;
}
.sim{
  color:#fff;
  cursor:pointer;
  font-weight:700;
  width:100%;
}
.sim:hover{filter:brightness(1.12)}

/* Panel configuración */
#configPanel{
  position:absolute; top:64px; left:0;
  min-width:340px; max-width:420px;
  display:none; flex-direction:column; gap:14px;
  z-index:21;
  text-align:left;
}
.cfgRow{display:flex;gap:10px;align-items:center;justify-content:space-between}
.cfgRow label{font-weight:800}
.cfgRow small{opacity:.85;font-weight:600}
.cfgRow input[type="checkbox"]{transform:scale(1.2)}
.cfgBlock{display:flex;flex-direction:column;gap:8px}
.cfgBlock select,.cfgBlock input[type="file"]{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.22);
  background:rgba(0,0,0,.25);
  color:#fff;
  outline:none;
}
.cfgHelp{font-size:12px;opacity:.9;line-height:1.25}
.cfgDivider{height:1px;background:rgba(255,255,255,.18);margin:4px 0}
.cfgTitle{font-size:14px;font-weight:900;letter-spacing:.2px}
.cfgBtnRow{display:flex;gap:10px;justify-content:flex-end}
.cfgBtnRow .btn{padding:10px 14px}

/* Bitácora */
#log{max-height:44vh;overflow:auto;color:#fff;text-align:left}
#log h3{margin:0 0 8px;font-size:16px;color:#fff;text-align:left}
.entry{
  display:grid;grid-template-columns:auto 1fr;gap:8px;
  padding:10px;border-radius:14px;background:rgba(255,255,255,.06);
  margin-bottom:8px;color:#fff;text-align:left;
}
.dot{width:14px;height:14px;border-radius:50%;margin-top:3px;box-shadow:0 0 0 2px rgba(0,0,0,.3) inset}
.meta{font-size:12px;line-height:1.25;color:#fff}
.meta b{color:#fff}

/* HUD y semáforo */
#hud{position:fixed;left:14px;bottom:60px;z-index:9;width:300px;color:#fff;text-align:left}
#hud h1{margin:0 0 8px;font-size:22px;color:#fff}
#hud p{margin:6px 0 0;font-size:16px;font-weight:800;color:#fff}

#sema{position:fixed;right:14px;bottom:60px;z-index:9;width:360px;color:#fff}
#foco{width:40px;height:40px;margin:0 auto 10px;border-radius:50%;background:#999;box-shadow:0 0 14px rgba(0,0,0,.5) inset,0 0 8px rgba(0,0,0,.35)}
.barWrap{position:relative; padding-bottom:26px;}
.bar{display:flex;height:28px;border-radius:10px;overflow:hidden;font-size:11px;font-weight:900}
.bar div{flex:1;display:flex;align-items:center;justify-content:center;color:#fff}
.leve{background:#00c853}
.mod{background:#ffc400}
.fue{background:#ff3b4a}
.viol{background:#7a001f}
.ext{background:#6a00ff}
#flecha{
  position:absolute;
  left:0;
  bottom:0;
  transform:translateX(-50%);
  font-size:18px;
  text-shadow:0 1px 3px #000;
  color:#fff;
  user-select:none;
  transition:left .18s ease;
}

/* Logo */
#logoPop{position:fixed;top:50px;right:60px;z-index:9;width:280px;height:auto;user-select:none}

/* Overlay */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000}
#overlay .panel{max-width:90%}
#overlay h2{margin:0 0 6px;font-size:22px;color:#fff}
#overlay p{margin:0 0 14px;font-size:14px;color:#fff}
#overlay button{border:none;color:#000;background:#00c853;font-weight:900}
#overlay button:active{transform:scale(.98)}

/* Panel de error */
#errPanel{
  position:fixed;left:16px;right:16px;top:16px;z-index:2000;
  display:none;text-align:left;padding:16px 18px;
}
#errPanel b{display:block;margin-bottom:6px}
#errPanel code{
  display:block;white-space:pre-wrap;
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size:12px;opacity:.95;
}

/* ===== POPUP ALERTA (cristal) ===== */
#popupOverlay{
  position:fixed; inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1500;
  background:rgba(0,0,0,.35);
}
#popupCard{
  width:min(720px, 92vw);
  border-radius:26px;
  padding:26px 30px;
  text-align:center;
  position:relative;
}
#popupClose{
  position:absolute;
  left:18px;
  top:14px;
  width:42px;
  height:42px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.22);
  background:rgba(255,255,255,.08);
  color:#fff;
  cursor:pointer;
  font-weight:900;
  font-size:20px;
  display:flex;
  align-items:center;
  justify-content:center;
}
#popupClose:hover{filter:brightness(1.15)}
#popupIcon{
  width:110px;height:110px;
  margin:2px auto 8px;
  display:flex;align-items:center;justify-content:center;
}
#popupTitle{
  font-size:52px; line-height:1.05; letter-spacing:.5px;
  margin:6px 0 6px; font-weight:900;
}
#popupSub{
  font-size:34px; line-height:1.15;
  margin:0 0 16px; font-weight:900;
}
#popupMid{
  font-size:26px; font-weight:900;
  margin:10px 0 10px; letter-spacing:.4px;
}
#popupTimes{
  font-size:28px; font-weight:900; line-height:1.25;
}
#popupFooter{
  margin-top:18px; font-size:34px; font-weight:900; letter-spacing:.4px;
}
@media (max-width:560px){
  #popupTitle{font-size:38px}
  #popupSub{font-size:24px}
  #popupMid{font-size:18px}
  #popupTimes{font-size:20px}
  #popupFooter{font-size:22px}
  #popupIcon{width:84px;height:84px}
}
</style>
</head>

<body>
<div id="map"></div>

<div id="errPanel">
  <b>El mapa no pudo cargar</b>
  <code id="errText">--</code>
</div>

<!-- Assets locales -->
<img id="logoPop" src="https://carletes2010.github.io/monitorsismicov2/assets/poplogosasno.png" alt="SASNO" onerror="this.style.display='none'"/>

<div id="leftRail">
  <div id="ctrl">
    <div id="alertWrap">

      <button id="alertBtn" class="btn" aria-expanded="false" aria-controls="simMenu" title="Simulacros">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M12 2a6 6 0 0 0-6 6v2.278c0 .52-.214 1.018-.593 1.375L3.7 13.26A1 1 0 0 0 4.4 15h15.2a1 1 0 0 0 .7-1.74l-1.707-1.607a 1.98 1.98 0 0 1-.593-1.375V8a6 6 0 0 0-6-6Zm0 20a3 3 0 0 0 3-3H9a3 3 0 0 0 3 3Z"/>
        </svg>
        <span>Alerta</span>
      </button>

      <button id="cfgBtn" class="btn" aria-expanded="false" aria-controls="configPanel" title="Configuración">
        <span style="font-size:18px;line-height:1">⚙️</span>
        <span>Config</span>
      </button>

      <div id="simMenu" role="menu" aria-label="Simulacros">
        <button class="sim" id="simLEV">Simular Leve</button>
        <button class="sim" id="simMOD">Simular Moderado</button>
        <button class="sim" id="simFUE">Simular Fuerte</button>
        <button class="sim" id="simVIO">Simular Violento</button>
        <button class="sim" id="simEXT">Simular Extremo</button>
        <button class="sim" id="simCLR">Limpiar</button>
      </div>

      <div id="configPanel" role="dialog" aria-label="Configuración">
        <div class="cfgTitle">Configuración</div>
        <div class="cfgDivider"></div>

        <div class="cfgRow">
          <div>
            <label>Mostrar centrales SASMEX</label><br/>
            <small>Azul oscuro, rojo en alerta</small>
          </div>
          <input id="toggleCentrales" type="checkbox"/>
        </div>

        <div class="cfgRow">
          <div>
            <label>Mostrar bitácora</label><br/>
            <small>Panel de eventos</small>
          </div>
          <input id="toggleLog" type="checkbox"/>
        </div>

        <div class="cfgRow">
          <div>
            <label>Pop up (solo alerta)</label><br/>
            <small>Solo FUE/VIOL/EXT (muestra ESTADO)</small>
          </div>
          <input id="togglePopup" type="checkbox"/>
        </div>

        <div class="cfgDivider"></div>

        <div class="cfgBlock">
          <label style="font-weight:800">Sonido para sismos fuertes (FUE/VIOL/EXT)</label>
          <select id="strongSoundSelect">
            <option value="https://carletes2010.github.io/monitorsismicov2/assets/alertaudio.mp3">Predeterminado (alertaudio.mp3)</option>
            <option value="https://carletes2010.github.io/monitorsismicov2/assets/advisory.mp3">Alterno (advisory.mp3)</option>
          </select>
          <input id="strongSoundFile" type="file" accept="audio/*"/>
          <div class="cfgHelp">Puedes elegir un sonido predefinido o subir un archivo (solo sesión).</div>
        </div>

        <div class="cfgDivider"></div>
        <div class="cfgBtnRow"><button id="cfgClose" class="btn">Cerrar</button></div>
      </div>

    </div>
  </div>

  <div id="log">
    <h3>Bitácora de eventos</h3>
    <div id="logList" aria-live="polite"></div>
  </div>
</div>

<div id="hud">
  <h1 id="tit">Monitoreando</h1>
  <p id="dist">Distancia: -- km</p>
  <p id="eta">ETA: -- seg</p>
</div>

<div id="sema">
  <div id="foco"></div>
  <div class="barWrap">
    <div class="bar" id="sevBar">
      <div class="leve">LEVE</div>
      <div class="mod">MOD</div>
      <div class="fue">FUE</div>
      <div class="viol">VIOL</div>
      <div class="ext">EXT</div>
    </div>
    <div id="flecha">▲</div>
  </div>
</div>

<div id="overlay">
  <div class="panel">
    <h2>Presiona para activar sistema</h2>
    <p>Habilita audio y notificaciones de alerta</p>
    <button id="activateBtn" class="btn">Activar</button>
  </div>
</div>

<!-- ===== POPUP ALERTA ===== -->
<div id="popupOverlay" aria-hidden="true">
  <div id="popupCard" role="dialog" aria-label="Pop up de alerta sísmica">
    <button id="popupClose" aria-label="Cerrar">×</button>

    <div id="popupIcon" aria-hidden="true">
      <svg viewBox="0 0 64 64" width="100%" height="100%">
        <path d="M32 6 L60 54 H4 Z" fill="none" stroke="white" stroke-width="5" opacity="0.95"/>
        <path d="M32 22 v18" stroke="white" stroke-width="6" stroke-linecap="round"/>
        <circle cx="32" cy="48" r="3.5" fill="white"/>
      </svg>
    </div>

    <div id="popupTitle">ALERTA SÍSMICA</div>
    <div id="popupSub">SISMO EN -- (-- KM)</div>

    <div id="popupMid">ANTICIPACIÓN</div>
    <div id="popupTimes">
      <div>ONDA S: <span id="popupS">--</span>S</div>
      <div>ONDA P: <span id="popupP">--</span>S</div>
    </div>

    <div id="popupFooter"><span id="popupDate">--</span> - MONITOR SASNO</div>
  </div>
</div>

<!-- Assets locales -->
<audio id="eqwAudio" src="https://carletes2010.github.io/monitorsismicov2/assets/alertaudio.mp3" preload="auto" playsinline></audio>
<audio id="advAudio" src="https://carletes2010.github.io/monitorsismicov2/assets/advisory.mp3" preload="auto" playsinline></audio>

<script>
/* Errores */
(function(){
  const showErr = (msg)=>{
    const panel=document.getElementById('errPanel');
    const txt=document.getElementById('errText');
    panel.style.display='block';
    txt.textContent=String(msg || 'Error desconocido');
  };
  window.addEventListener('error', (e)=>showErr(e?.message || e));
  window.addEventListener('unhandledrejection', (e)=>showErr(e?.reason || e));
})();
</script>

<script>
mapboxgl.accessToken='pk.eyJ1IjoiYWx6b2FsZXJ0YXNpc21pY2EiLCJhIjoiY2wyNHM2c25vMjNoejNpcWRrb3Y4MzV6ciJ9.D2pXLxF0emuIHvrW-n181Q';

const $=id=>document.getElementById(id);
const tit=$('tit'),dist=$('dist'),eta=$('eta'),foco=$('foco'),flecha=$('flecha');
const sevBar=$('sevBar');
const eqwAudio=$('eqwAudio'), advAudio=$('advAudio');
const overlay=$('overlay'), activateBtn=$('activateBtn');
const logPanel=$('log'), logList=$('logList');

const alertBtn=$('alertBtn'), simMenu=$('simMenu');
const cfgBtn=$('cfgBtn'), configPanel=$('configPanel'), cfgClose=$('cfgClose');

const toggleCentrales=$('toggleCentrales');
const toggleLog=$('toggleLog');
const togglePopup=$('togglePopup');

const strongSoundSelect = $('strongSoundSelect');
const strongSoundFile = $('strongSoundFile');

/* Popup DOM */
const popupOverlay=$('popupOverlay');
const popupClose=$('popupClose');
const popupSub=$('popupSub');
const popupS=$('popupS');
const popupP=$('popupP');
const popupDate=$('popupDate');

const CDMX = [-99.1332, 19.4326];
const FIXED_ZOOM = 5.7;
const EVENT_DURATION_MS = 120000;

/* Popup delay */
const POPUP_DELAY_MS = 15000;

/* Clasificaciones */
const COLORS={ leve:'#00c853', mod:'#ffc400', fue:'#ff3b4a', viol:'#7a001f', ext:'#6a00ff' };
const LABELS={ leve:'Sismo Leve', mod:'Sismo Moderado', fue:'Sismo Fuerte', viol:'Sismo Violento', ext:'Sismo Extremo' };
const ORDER=['leve','mod','fue','viol','ext'];
const IDX=Object.fromEntries(ORDER.map((k,i)=>[k,i]));

/* Velocidades km/s para popup */
const SPEED_S = 5.0;
const SPEED_P = 8.0;

/* Ondas */
const WAVE_P = '#ffc400';
const WAVE_S = '#ff3b4a';

/* Centrales */
const CENTRALES_BLUE = '#0b1b3a';
const CENTRALES_BLUE_STROKE = '#122a57';
const CENTRALES_RED = '#ff1a1a';
const CENTRALES_RED_STROKE = '#7a001f';

let map, anim, timer;
let lastEvt=null;
let audioPrimed=false;
let mapReady=false;

/* Animaciones centrales */
let centralesAlertRAF=null;
let centralesAlertUntil=0;

/* Popup control */
let popupToken=0;
let popupDismissedToken=0;
let popupUpdateRAF=null;
let popupDelayTimer=null;

/* Centrales (9) */
const CENTRALES = [
  {id:'CDMX', name:'Ciudad de México', lng:-99.1332, lat:19.4326},
  {id:'OAX',  name:'Oaxaca',           lng:-96.7266, lat:17.0732},
  {id:'ACA',  name:'Acapulco',         lng:-99.9092, lat:16.8531},
  {id:'CHP',  name:'Chilpancingo',     lng:-99.5000, lat:17.5500},
  {id:'MOR',  name:'Morelia',          lng:-101.1844,lat:19.7050},
  {id:'PUE',  name:'Puebla',           lng:-98.2063, lat:19.0414},
  {id:'CUA',  name:'Cuernavaca',       lng:-99.2370, lat:18.9242},
  {id:'COL',  name:'Colima',           lng:-103.7240,lat:19.2433},
  {id:'TOL',  name:'Toluca',           lng:-99.6557, lat:19.2826}
];

/* Geometría */
const circ=([lo,la],r,n=96)=>{
  const cos=Math.max(0.1,Math.cos(la*Math.PI/180));
  const dx=r/(111320*cos), dy=r/110574, c=[];
  for(let i=0;i<n;i++){ const a=2*Math.PI*i/n; c.push([lo+dx*Math.cos(a), la+dy*Math.sin(a)]) }
  c.push(c[0]);
  return {type:'Feature',geometry:{type:'Polygon',coordinates:[c]}};
};
const km=(a,b,c,d)=>{
  const R=6371,x=.017453;
  return 2*R*Math.asin(Math.sqrt(.5-.5*Math.cos((c-a)*x)+Math.cos(a*x)*Math.cos(c*x)*(.5-.5*Math.cos((d-b)*x))));
};

/* Persistencia */
const LS_KEYS = {
  strongSound:'cfg_strong_sound_url',
  showCentrales:'cfg_show_centrales',
  showLog:'cfg_show_log',
  showPopup:'cfg_show_popup'
};
function loadCfg(){
  const soundUrl = localStorage.getItem(LS_KEYS.strongSound);
  if(soundUrl){
    strongSoundSelect.value = soundUrl;
    eqwAudio.src = soundUrl;
  }

  const sc = localStorage.getItem(LS_KEYS.showCentrales);
  toggleCentrales.checked = (sc === null) ? true : (sc === '1');

  const sl = localStorage.getItem(LS_KEYS.showLog);
  toggleLog.checked = (sl === null) ? true : (sl === '1');

  const sp = localStorage.getItem(LS_KEYS.showPopup);
  togglePopup.checked = (sp === null) ? false : (sp === '1');

  applyLogVisibility();
}
function saveCfg(){
  localStorage.setItem(LS_KEYS.strongSound, strongSoundSelect.value);
  localStorage.setItem(LS_KEYS.showCentrales, toggleCentrales.checked ? '1':'0');
  localStorage.setItem(LS_KEYS.showLog, toggleLog.checked ? '1':'0');
  localStorage.setItem(LS_KEYS.showPopup, togglePopup.checked ? '1':'0');
}

/* Bitácora visible/oculta */
function applyLogVisibility(){
  logPanel.style.display = toggleLog.checked ? 'block' : 'none';
}

/* Semáforo: flecha centrada por ancho real */
function setArrowByIndex(idx){
  idx = Math.max(0, Math.min(ORDER.length-1, idx));
  const rect = sevBar.getBoundingClientRect();
  const seg = rect.width / ORDER.length;
  const x = seg * (idx + 0.5);
  flecha.style.left = `${x}px`;
}
function setArrowByTipo(tipo){
  const idx = (tipo in IDX) ? IDX[tipo] : IDX.fue;
  setArrowByIndex(idx);
}
window.addEventListener('resize', ()=>{
  if(lastEvt?.tipo) setArrowByTipo(lastEvt.tipo);
  else setArrowByIndex(2);
});

/* Audio prime */
activateBtn.addEventListener('click', ()=>{
  if(!audioPrimed){
    [eqwAudio,advAudio].forEach(a=>{
      const v=a.volume; a.volume=0.0001;
      a.play().then(()=>{a.pause(); a.currentTime=0; a.volume=v;}).catch(()=>{});
    });
    audioPrimed=true;
  }
  overlay.style.display='none';
}, {once:true});

/* Menús */
function closeAllMenus(){
  simMenu.style.display='none';
  configPanel.style.display='none';
  alertBtn.setAttribute('aria-expanded','false');
  cfgBtn.setAttribute('aria-expanded','false');
}
alertBtn.onclick=()=>{
  const open = simMenu.style.display==='flex';
  closeAllMenus();
  simMenu.style.display = open ? 'none' : 'flex';
  alertBtn.setAttribute('aria-expanded', String(!open));
};
cfgBtn.onclick=()=>{
  const open = configPanel.style.display==='flex';
  closeAllMenus();
  configPanel.style.display = open ? 'none' : 'flex';
  cfgBtn.setAttribute('aria-expanded', String(!open));
};
cfgClose.onclick=()=>closeAllMenus();
document.addEventListener('click', (e)=>{
  if(!document.getElementById('alertWrap').contains(e.target)) closeAllMenus();
});

/* Config: sonido fuerte */
strongSoundSelect.addEventListener('change', ()=>{
  eqwAudio.src = strongSoundSelect.value;
  saveCfg();
});
strongSoundFile.addEventListener('change', ()=>{
  const f = strongSoundFile.files && strongSoundFile.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  eqwAudio.src = url;
});

/* Config: centrales */
toggleCentrales.addEventListener('change', ()=>{
  saveCfg();
  if(mapReady) applyCentralesVisibility();
  if(!toggleCentrales.checked) stopCentralesAlert();
});

/* Config: bitácora */
toggleLog.addEventListener('change', ()=>{
  saveCfg();
  applyLogVisibility();
});

/* Config: popup */
togglePopup.addEventListener('change', ()=>{
  saveCfg();
  if(!togglePopup.checked) hidePopup();
});

/* Popup: close */
popupClose.onclick=()=>{
  popupDismissedToken = popupToken;
  hidePopup();
};
popupOverlay.addEventListener('click', (e)=>{
  if(e.target === popupOverlay){
    popupDismissedToken = popupToken;
    hidePopup();
  }
});

/* Mapa fijo */
function initMap(){
  map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/outdoors-v12',
    center: CDMX,
    zoom: FIXED_ZOOM,
    minZoom: FIXED_ZOOM,
    maxZoom: FIXED_ZOOM,
    interactive: false
  });

  map.scrollZoom.disable();
  map.boxZoom.disable();
  map.dragRotate.disable();
  map.dragPan.disable();
  map.keyboard.disable();
  map.doubleClickZoom.disable();
  map.touchZoomRotate.disable();
  map.touchPitch.disable();

  map.on('load', ()=>{
    mapReady=true;
    ensureWaveScaffold();
    addCentralesLayers();
    applyCentralesVisibility();
    setArrowByIndex(2);
    if(lastEvt) drawEvent(lastEvt);
  });
}

/* Ondas */
function ensureWaveScaffold(){
  const tiny = circ(CDMX, 1);

  if(!map.getSource('ondaP')) map.addSource('ondaP',{type:'geojson', data:tiny});
  if(!map.getSource('ondaS')) map.addSource('ondaS',{type:'geojson', data:tiny});

  if(!map.getLayer('ondaP-fill'))
    map.addLayer({id:'ondaP-fill', type:'fill', source:'ondaP',
      paint:{'fill-color':'transparent','fill-outline-color':WAVE_P}});
  if(!map.getLayer('ondaP-line'))
    map.addLayer({id:'ondaP-line', type:'line', source:'ondaP',
      paint:{'line-color':WAVE_P,'line-width':2,'line-opacity':1},
      layout:{'line-join':'round','line-cap':'round'}});

  if(!map.getLayer('ondaS-fill'))
    map.addLayer({id:'ondaS-fill', type:'fill', source:'ondaS',
      paint:{'fill-color':'transparent','fill-outline-color':WAVE_S}});
  if(!map.getLayer('ondaS-line'))
    map.addLayer({id:'ondaS-line', type:'line', source:'ondaS',
      paint:{'line-color':WAVE_S,'line-width':2,'line-opacity':1},
      layout:{'line-join':'round','line-cap':'round'}});
}
function resetWaves(){
  const tiny=circ(CDMX,1);
  map.getSource('ondaP')?.setData(tiny);
  map.getSource('ondaS')?.setData(tiny);
}

/* Centrales */
function addCentralesLayers(){
  const features = CENTRALES.map(c=>({
    type:'Feature',
    properties:{id:c.id,name:c.name},
    geometry:{type:'Point',coordinates:[c.lng,c.lat]}
  }));

  if(!map.getSource('centrales')){
    map.addSource('centrales',{type:'geojson',data:{type:'FeatureCollection',features}});
  }

  if(!map.getLayer('centrales-dot')){
    map.addLayer({
      id:'centrales-dot',
      type:'circle',
      source:'centrales',
      paint:{
        'circle-radius': 6,
        'circle-color': CENTRALES_BLUE,
        'circle-stroke-width': 2,
        'circle-stroke-color': CENTRALES_BLUE_STROKE,
        'circle-opacity': 0.95
      }
    });
  }

  if(!map.getLayer('centrales-alert')){
    map.addLayer({
      id:'centrales-alert',
      type:'circle',
      source:'centrales',
      paint:{
        'circle-radius': 10,
        'circle-color': '#ff1a1a',
        'circle-opacity': 0.0
      }
    });
  }

  if(!map.getLayer('centrales-label')){
    map.addLayer({
      id:'centrales-label',
      type:'symbol',
      source:'centrales',
      layout:{
        'text-field':['get','id'],
        'text-size': 12,
        'text-offset':[0,1.2],
        'text-anchor':'top'
      },
      paint:{
        'text-color':'#ffffff',
        'text-halo-color':'rgba(0,0,0,0.75)',
        'text-halo-width':1.4
      }
    });
  }
}

function setCentralesNormal(){
  if(!mapReady || !map.getLayer('centrales-dot')) return;
  map.setPaintProperty('centrales-dot','circle-color', CENTRALES_BLUE);
  map.setPaintProperty('centrales-dot','circle-stroke-color', CENTRALES_BLUE_STROKE);
}
function setCentralesActiveRed(){
  if(!mapReady || !map.getLayer('centrales-dot')) return;
  map.setPaintProperty('centrales-dot','circle-color', CENTRALES_RED);
  map.setPaintProperty('centrales-dot','circle-stroke-color', CENTRALES_RED_STROKE);
}
function stopCentralesAlert(){
  if(centralesAlertRAF) cancelAnimationFrame(centralesAlertRAF);
  centralesAlertRAF=null;
  centralesAlertUntil=0;
  if(mapReady && map.getLayer('centrales-alert')){
    map.setPaintProperty('centrales-alert','circle-opacity', 0.0);
  }
}
function applyCentralesVisibility(){
  const on = !!toggleCentrales.checked;
  ['centrales-dot','centrales-alert','centrales-label'].forEach(id=>{
    if(map.getLayer(id)) map.setLayoutProperty(id,'visibility', on ? 'visible':'none');
  });
}

/* Pulso único (leve/mod) */
function oneShotPulse(color){
  if(!mapReady || !toggleCentrales.checked) return;
  if(!map.getLayer('centrales-alert')) return;

  stopCentralesAlert();
  map.setPaintProperty('centrales-alert','circle-color', color);

  const start = performance.now();
  const D = 1600;

  (function step(now){
    const p = Math.min(1, (now-start)/D);
    const ease = 1 - Math.pow(1-p, 3);

    map.setPaintProperty('centrales-alert','circle-radius', 10 + 34*ease);
    map.setPaintProperty('centrales-alert','circle-opacity', (1-p)*0.55);

    if(p < 1) centralesAlertRAF = requestAnimationFrame(step);
    else {
      map.setPaintProperty('centrales-alert','circle-opacity', 0.0);
      centralesAlertRAF=null;
    }
  })(start);
}

/* Alerta sostenida (fuerte+) */
function sustainedAlarm(durationMs){
  if(!mapReady || !toggleCentrales.checked) return;
  if(!map.getLayer('centrales-alert')) return;

  stopCentralesAlert();
  map.setPaintProperty('centrales-alert','circle-color', '#ff1a1a');

  const start = performance.now();
  centralesAlertUntil = start + durationMs;

  (function tick(now){
    if(now >= centralesAlertUntil){
      stopCentralesAlert();
      return;
    }
    const t = (now - start) / 1000;
    const fast = (Math.sin(t * 7.5) + 1) / 2;
    const slow = (Math.sin(t * 2.2) + 1) / 2;
    const radius = 10 + 34*fast + 14*slow;
    const opacity = 0.18 + 0.55*(1-fast);

    map.setPaintProperty('centrales-alert','circle-radius', radius);
    map.setPaintProperty('centrales-alert','circle-opacity', opacity);

    centralesAlertRAF = requestAnimationFrame(tick);
  })(start);
}

/* ===== ESTADO (REGION) del epicentro: SOLO ESTADO (más confiable) ===== */
function normalizeStateName(name){
  if(!name) return null;
  let s = String(name).trim();

  s = s.replace(/^estado de\s+/i, '');
  s = s.replace(/^province of\s+/i, '');
  s = s.replace(/^state of\s+/i, '');

  if(/^mexico city$/i.test(s) || /^ciudad de mexico$/i.test(s) || /^cdmx$/i.test(s)){
    s = 'Ciudad de México';
  }

  return s.toUpperCase();
}

async function resolveEpicenterState(lat, lng){
  try{
    const url =
      `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json` +
      `?types=place,locality,district,region&language=es&limit=1&access_token=${mapboxgl.accessToken}`;

    const r = await fetch(url);
    const j = await r.json();
    if(!j || !Array.isArray(j.features) || j.features.length === 0) return null;

    const f = j.features[0];
    const pt0 = f.place_type && f.place_type[0];

    if(pt0 === 'region'){
      return normalizeStateName(f.text_es || f.text);
    }

    const ctx = Array.isArray(f.context) ? f.context : [];
    const regionCtx = ctx.find(x => typeof x.id === 'string' && x.id.startsWith('region.'));
    if(regionCtx){
      return normalizeStateName(regionCtx.text_es || regionCtx.text);
    }

    const regionFeat = j.features.find(x => x.place_type && x.place_type[0] === 'region');
    if(regionFeat){
      return normalizeStateName(regionFeat.text_es || regionFeat.text);
    }

    return null;
  }catch(e){
    return null;
  }
}

/* Bitácora */
function addToLog({tipo, estado, latitud, longitud}, eta0Sec){
  if(!toggleLog.checked) return;
  const color = COLORS[tipo] || '#999';
  const ts = new Date().toLocaleString(undefined,{
    year:'numeric',month:'2-digit',day:'2-digit',
    hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false
  });

  const tipoTexto = LABELS[tipo] || (tipo||'').toUpperCase();
  const label = estado
    ? `Sismo en ${estado}`
    : `Epicentro en ${Number(latitud).toFixed(2)}, ${Number(longitud).toFixed(2)}`;

  const li=document.createElement('div');
  li.className='entry';
  li.innerHTML=`
    <div class="dot" style="background:${color}"></div>
    <div class="meta">
      <b>${tipoTexto}</b> · ${ts}<br/>
      ${label} &nbsp;·&nbsp; Anticipación: ${Math.max(0,Math.round(eta0Sec))} s
    </div>`;
  logList.prepend(li);
  if(logList.children.length>200) logList.removeChild(logList.lastElementChild);
}

/* POPUP helpers */
function showPopup(){ popupOverlay.style.display='flex'; popupOverlay.setAttribute('aria-hidden','false'); }
function hidePopup(){
  popupOverlay.style.display='none';
  popupOverlay.setAttribute('aria-hidden','true');
  if(popupUpdateRAF) cancelAnimationFrame(popupUpdateRAF);
  popupUpdateRAF=null;
}
function fmtPopupDate(d){
  const dd=String(d.getDate()).padStart(2,'0');
  const mm=['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC'][d.getMonth()];
  const yy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0');
  const mi=String(d.getMinutes()).padStart(2,'0');
  const ss=String(d.getSeconds()).padStart(2,'0');
  return `${dd} ${mm} ${yy} ${hh}:${mi}:${ss}`;
}

/* Clear / Evento */
function clearEvent(){
  if(anim) cancelAnimationFrame(anim);
  if(timer) clearTimeout(timer);

  if(popupDelayTimer) clearTimeout(popupDelayTimer);
  popupDelayTimer=null;

  stopCentralesAlert();
  setCentralesNormal();

  if(mapReady) resetWaves();

  tit.textContent='Monitoreando';
  dist.textContent='Distancia: -- km';
  eta.textContent='ETA: -- seg';
  foco.style.background='#999';
  setArrowByIndex(2);

  hidePopup();

  [eqwAudio,advAudio].forEach(a=>{a.pause(); a.currentTime=0;});
  lastEvt=null;
}

async function drawEvent(evt){
  lastEvt=evt;
  if(!mapReady) return;

  ensureWaveScaffold();
  clearEvent();
  lastEvt=evt;

  popupToken = Date.now();
  popupDismissedToken = 0;

  const {latitud,longitud}=evt;
  let tipo = evt.tipo || 'fue';
  tipo = (tipo in COLORS) ? tipo : 'fue';

  const color=COLORS[tipo];
  tit.textContent=LABELS[tipo]||'Monitoreando';
  foco.style.background=color;

  setArrowByTipo(tipo);

  const epic=[longitud,latitud];
  const d=km(epic[1],epic[0],CDMX[1],CDMX[0]);
  dist.textContent=`Distancia: ${d.toFixed(1)} km`;

  /* ETA HUD (S) */
  const etaS0 = d / SPEED_S;
  eta.textContent=`ETA: ${etaS0.toFixed(0)} seg`;

  /* ===== estado (solo) ===== */
  const stateUp = await resolveEpicenterState(latitud, longitud);
  addToLog({tipo, estado: stateUp, latitud, longitud}, etaS0);

  /* Centrales */
  if(['fue','viol','ext'].includes(tipo)){
    setCentralesActiveRed();
    sustainedAlarm(EVENT_DURATION_MS);
  }else{
    setCentralesNormal();
    oneShotPulse(color);
  }

  /* Popup (solo alerta) => SOLO ESTADO y aparece en 15s */
  const isAlert = ['fue','viol','ext'].includes(tipo);
  if(isAlert && togglePopup.checked){
    popupDelayTimer = setTimeout(()=>{
      if(!lastEvt) return;
      if(popupDismissedToken === popupToken) return;

      const labelState = stateUp || '---';
      popupSub.textContent = `SISMO EN ${labelState} (${Math.round(d)} KM)`;
      popupDate.textContent = fmtPopupDate(new Date());

      popupS.textContent = Math.max(0, Math.round(etaS0 - (POPUP_DELAY_MS/1000)));
      popupP.textContent = Math.max(0, Math.round((d / SPEED_P) - (POPUP_DELAY_MS/1000)));

      showPopup();

      const tStart = performance.now();
      const offset = POPUP_DELAY_MS/1000;

      (function popTick(now){
        if(popupDismissedToken === popupToken) return;
        const elapsed = (now - tStart)/1000 + offset;

        const sLeft = Math.max(0, Math.round(etaS0 - elapsed));
        const pLeft = Math.max(0, Math.round((d / SPEED_P) - elapsed));

        popupS.textContent = sLeft;
        popupP.textContent = pLeft;
        popupDate.textContent = fmtPopupDate(new Date());

        if(elapsed < (EVENT_DURATION_MS/1000)){
          popupUpdateRAF = requestAnimationFrame(popTick);
        }
      })(tStart);

    }, POPUP_DELAY_MS);
  }

  /* Ondas + ETA */
  const t0=performance.now();
  (function step(now){
    const s=(now-t0)/1000;
    if(s>(EVENT_DURATION_MS/1000)) return;

    map.getSource('ondaP')?.setData(circ(epic, Math.max(1,8000*s)));
    map.getSource('ondaS')?.setData(circ(epic, Math.max(1,5000*s)));

    eta.textContent=`ETA: ${Math.max(etaS0-s,0).toFixed(0)} seg`;
    anim=requestAnimationFrame(step);
  })(t0);

  timer=setTimeout(clearEvent, EVENT_DURATION_MS);

  const toPlay=(['fue','viol','ext'].includes(tipo))?eqwAudio:advAudio;
  const toStop=(toPlay===eqwAudio)?advAudio:eqwAudio;
  toStop.pause(); toStop.currentTime=0;
  if(audioPrimed){ toPlay.currentTime=0; toPlay.play().catch(()=>{}); }
}

/* Simulacros */
$('simLEV').onclick=()=>drawEvent({latitud:19.0,longitud:-99.4,tipo:'leve'});
$('simMOD').onclick=()=>drawEvent({latitud:18.2,longitud:-100.2,tipo:'mod'});
$('simFUE').onclick=()=>drawEvent({latitud:19.05,longitud:-98.20,tipo:'fue'});
$('simVIO').onclick=()=>drawEvent({latitud:16.3,longitud:-98.9,tipo:'viol'});
$('simEXT').onclick=()=>drawEvent({latitud:15.9,longitud:-97.8,tipo:'ext'});
$('simCLR').onclick=()=>clearEvent();

/* Pusher */
const pusher=new Pusher('0f74c31648d3adb34e1b',{cluster:'us2',forceTLS:true});
pusher.subscribe('alertas-sasno').bind('mapa_pop', d=>{
  if(d && typeof d.latitud==='number' && typeof d.longitud==='number') drawEvent(d);
  else clearEvent();
});

/* Inicio */
loadCfg();
initMap();
</script>
</body>
</html>
